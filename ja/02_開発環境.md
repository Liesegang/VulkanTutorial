この章では、Vulkanアプリケーションを開発するための環境を構築し、便利なライブラリをインストールします。ここで使用するツールは、コンパイラを除いてすべてWindows、Linux、MacOSと互換性がありますが、インストールの手順が少し異なるので、ここでは個別に説明します。

## Windows

Windows 用に開発する場合、Visual Studio を使用してコードをコンパイルしていると仮定します。C++17 を完全にサポートするには、Visual Studio 2017 または 2019 のいずれかを使用する必要があります。以下に概説する手順は、VS 2017 用に書かれたものです。

### Vulkan SDK

Vulkanアプリケーションの開発に必要な最も重要なコンポーネントはSDKです。SDKには、ヘッダ、標準のバリデーションレイヤー、デバッグツール、Vulkan関数のためのローダが含まれています。ローダは、実行時にドライバ内の関数を検索します。もし、あなたがよく知っているのならば、それはOpenGL用のGLEWと同様です。

SDKは、[LunarGウェブサイト](https://vulkan.lunarg.com/)のページ下部のボタンをからダウンロードすることができます。アカウントを作成する必要はありませんが、作成することで、有用なドキュメントにアクセスすることができます。

![](/images/vulkan_sdk_download_buttons.png)

インストールを進める際、SDKをインストールしたディレクトリを覚えておいてください。まず最初に行うのは、お使いのグラフィックカードとドライバがVulkanを適切にサポートしているかどうか確認することです。SDKをインストールしたディレクトリに移動し、`Bin`ディレクトリを開き、`vkcube.exe`デモを実行します。すると以下のように表示されるはずです。

![](/images/cube_demo.png)

エラーメッセージが表示された場合は、ドライバが最新であり、Vulkan ランタイムを含んでいること、グラフィックカードがサポートされていることを確認してください。主要なベンダーのドライバへのリンクについては、[導入] (!ja/導入)を参照してください。

このディレクトリには、開発に役立つもう一つのプログラムがあります。`glslangValidator.exe` と `glslc.exe` プログラムは、人が読める [GLSL](https://ja.wikipedia.org/wiki/GLSL)からバイトコードにシェーダをコンパイルするために使われます。これについては [shader modules] (!ja/三角形を描く/グラフィックスパイプラインの基礎/シェーダモジュール) の章で詳しく説明します。`Bin` ディレクトリには Vulkan ローダとバリデーションレイヤーのバイナリが、`Lib` ディレクトリにはそれらのライブラリが格納されています。

最後に、Vulkanヘッダを含む `Include` ディレクトリがあります。他のファイルも自由に探索してください。しかし、このチュートリアルでは必要ありません。

### GLFW

前述の通り、Vulkan自体がプラットフォームに依存しないAPIであるため、レンダリング結果を表示するためのウィンドウを作成するためのツールは含まれていません。Vulkanのクロスプラットフォームの利点を享受し、Win32の恐怖を避けるために、Windows、Linux、MacOSに対応した[GLFWライブラリ](http://www.glfw.org/)を使ってウィンドウを作成します。[SDL](https://www.libsdl.org/)のような他のライブラリもありますが、GLFWの利点は、ウィンドウの作成以外にもVulkanにまつわるプラットフォーム固有のことを抽象化していることです。

GLFW の最新版は [公式サイト](http://www.glfw.org/download.html) で公開されています。このチュートリアルでは64ビットのバイナリを使用しますが、もちろん32ビットでビルドすることもできます。その場合は、`Lib`ではなく`Lib32`ディレクトリにあるVulkan SDKのバイナリにリンクしてください。ダウンロードしたら、お好きななディレクトリにアーカイブを展開します。私は、Visual Studioディレクトリのdocumentsの下に`Libraries`ディレクトリを作成することにしました。

![](/images/glfw_directory.png)

### GLM

DirectX 12と違ってVulkanには線形代数演算用のライブラリが含まれていないので、ダウンロードする必要があります。[GLM](http://glm.g-truc.net/)は、グラフィックスAPIでの使用を想定して設計されており、OpenGLでもよく使われている素敵なライブラリです。

GLMはヘッダのみのライブラリなので、[最新版](https://github.com/g-truc/glm/releases)をダウンロードして便利な場所に保存するだけでOKです。以下のようなディレクトリ構造にしてください。

![](/images/library_directory.png)

### Visual Studioのセットアップ

依存するすべてのライブラリのインストールが終わったので、Vulkan用の基本的なVisual Studioプロジェクトをセットアップし、すべてが動作することを確認するためのコードを少し書いてみましょう。

Visual Studioを起動し、名前を入力して `OK` を押して新しい`Windows Desktop Wizard`プロジェクトを作成します。

![](/images/vs_new_cpp_project.png)

デバッグメッセージを表示する場所が必要なので、アプリケーションタイプとして `Console Application (.exe)` を選択します。`Empty Project` にチェックを入れて、Visual Studioがボイラープレートコードを追加しないようにします。

![](/images/vs_application_settings.png)

`OK`を押すとプロジェクトが作成されます。C++のソースファイルを追加してください。すでにその手順を知っているとは思いますが、完全性のためにここに手順を示しておきます。

![](/images/vs_new_item.png)

![](/images/vs_new_source_file.png)

では、次のコードをファイルに追加してください。今すぐにコードを理解しようとしなくて問題ありません。Vulkanアプリケーションをコンパイルして実行できることを確認するだけのコードです。次の章ではまたゼロから書き始めます。

```c++
#define GLFW_INCLUDE_VULKAN
#include <GLFW/glfw3.h>

#define GLM_FORCE_RADIANS
#define GLM_FORCE_DEPTH_ZERO_TO_ONE
#include <glm/vec4.hpp>
#include <glm/mat4x4.hpp>

#include <iostream>

int main() {
    glfwInit();

    glfwWindowHint(GLFW_CLIENT_API, GLFW_NO_API);
    GLFWwindow* window = glfwCreateWindow(800, 600, "Vulkan window", nullptr, nullptr);

    uint32_t extensionCount = 0;
    vkEnumerateInstanceExtensionProperties(nullptr, &extensionCount, nullptr);

    std::cout << extensionCount << " extensions supported\n";

    glm::mat4 matrix;
    glm::vec4 vec;
    auto test = matrix * vec;

    while(!glfwWindowShouldClose(window)) {
        glfwPollEvents();
    }

    glfwDestroyWindow(window);

    glfwTerminate();

    return 0;
}
```

それでは、エラーが発生しないようにプロジェクトを設定しましょう。プロジェクトのプロパティダイアログを開き、`All Configurations`が選択されていることを確認してください。ほとんどの設定は`Debug`と`Release`モードの両方に適用するからです。

![](/images/vs_open_project_properties.png)

![](/images/vs_all_configs.png)

`C++ -> General -> Additional Include Directories`へ行き、ドロップダウンボックス内の`<Edit...>`を押してください。

![](/images/vs_cpp_general.png)

Vulkan, GLFW, GLMのヘッダーディレクトリを追加してください。

![](/images/vs_include_dirs.png)

次に、`Linker -> General`にあるライブラリディレクトリの編集画面を開いてください。

![](/images/vs_link_settings.png)

VulkanとGLFWのオブジェクトファイルのディレクトリを追加してください

![](/images/vs_link_dirs.png)


`Linker -> Input`へ行き、`Additional Dependencies`ドロップダウンボックス内の`<Edit...>`を押してください。

![](/images/vs_link_input.png)

VulkanとGLFWのオブジェクトファイルの名前を入力してください。

![](/images/vs_dependencies.png)

最後に、コンパイラをC++17の機能をサポートするように変更してください。

![](/images/vs_cpp17.png)

プロジェクトのプロパティダイアログを閉じてください。すべてが正しく行われていれば、コードの中でハイライトされているエラーはもう表示されないはずです。

最後に、実際に64ビットモードでコンパイルしていることを確認してください。

![](/images/vs_build_mode.png)

`F5`を押してプロジェクトをコンパイルして実行すると、コマンドプロンプトが表示され、このようなウィンドウが表示されるはずです。

![](/images/vs_test_window.png)

コマンドプロンプトに表示されるエクステンションの数は0以外であるはずです。おめでとうございます。これで [Vulkanで遊ぶ](!ja/三角形を描く/セットアップ/ベースコード)準備は完了です!

## Linux

これらの説明は Ubuntu ユーザを対象としていますが、`apt`コマンドを自分に適したパッケージマネージャコマンドに変更することで、この手順に沿って実行できるようになるかもしれません。C++17をサポートするコンパイラ(GCC 7+ または Clang 5+)が必要です。また、makeも必要です。

### Vulkan パッケージ

Linux上でVulkanアプリケーションを開発するために必要な最も重要なコンポーネントは、Vulkanローダ、バリデーションレイヤー、そしてマシンがVulkanに対応しているかどうかをテストするためのいくつかのコマンドラインユーティリティです。

* `sudo apt install vulkan-tools`: コマンドラインユーティリティをインストールします。最も重要なのは `vulkaninfo` と `vkcube` です。これらを実行して、お使いのマシンが Vulkan をサポートしているかどうかを確認してください。
* `sudo apt install libvulkan-dev`: Vulkan ローダをインストールします。ローダは、OpenGL 用の GLEW と同様に、実行時にドライバ内の関数を調べます。
* `sudo apt install vulkan-validationlayers-dev spirv-tools`: 標準のバリデーションレイヤーと必要な SPIR-V ツールをインストールします。これらはVulkanアプリケーションをデバッグする際に非常に重要です。次の章で説明します。

インストールに成功した場合は、Vulkan部分の設定が完了しているはずです。忘れずに `vkcube` を実行して、以下のようなポップアップがウィンドウに表示されることを確認してください。

![](/images/cube_demo_nowindow.png)

エラーメッセージが表示された場合は、ドライバが最新であり、Vulkan ランタイムを含んでいること、グラフィックカードがサポートされていることを確認してください。主要なベンダーのドライバへのリンクについては、[導入] (!ja/導入)を参照してください。

### GLFW

前述の通り、Vulkan自体がプラットフォームに依存しないAPIであるため、レンダリング結果を表示するためのウィンドウを作成するためのツールは含まれていません。Vulkanのクロスプラットフォームの利点を享受し、Win32の恐怖を避けるために、Windows、Linux、MacOSに対応した[GLFWライブラリ](http://www.glfw.org/)を使ってウィンドウを作成します。[SDL](https://www.libsdl.org/)のような他のライブラリもありますが、GLFWの利点は、ウィンドウの作成以外にもVulkanにまつわるプラットフォーム固有のことを抽象化していることです。

以下のコマンドでGLFWをインストールします。

```bash
sudo apt install libglfw3-dev
```

### GLM

DirectX 12と違ってVulkanには線形代数演算用のライブラリが含まれていないので、ダウンロードする必要があります。[GLM](http://glm.g-truc.net/)は、グラフィックスAPIでの使用を想定して設計されており、OpenGLでもよく使われている素敵なライブラリです。

これはヘッダのみのライブラリです。`libglm-dev` パッケージからインストールすることができます。

```bash
sudo apt install libglm-dev
```

### シェーダコンパイラ

最後に、人が読める[GLSL](https://ja.wikipedia.org/wiki/GLSL)からシェーダをバイトコードにコンパイルするプログラムが必要になります。

2つの人気のあるシェーダコンパイラはKhronos Groupの `glslangValidator` とGoogleの `glslc` です。後者は馴染み深いGCCやClangのような使い方なので、それを使ってみましょう。Googleの[非公式なバイナリ](https://github.com/google/shaderc/blob/main/downloads.md)をダウンロードして、`glslc`を `/usr/local/bin` にコピーします。パーミッションによっては `sudo` が必要になるかもしれないことに注意してください。テストするには、`glslc` を実行すると、インプットファイルがないとエラーが出ることを確認してください。

`glslc: error: no input files`

`glslc`については[shader modules] (!ja/三角形を描く/グラフィックスパイプラインの基礎/シェーダモジュール)の章で詳しく説明します。

### makefileプロジェクトのセットアップ

必要なものがすべてインストールできたので、Vulkan 用の基本的な makefile プロジェクトを設定し、すべてが動作することを確認するためのコードを少し書いてみましょう。

お好きな場所にに `VulkanTest` のような名前の新しいディレクトリを作成して、`main.cpp` というソースファイルを作成し、以下のコードを追加シてください。今すぐにコードを理解しようとしなくて問題ありません。Vulkanアプリケーションをコンパイルして実行できることを確認するだけのコードです。次の章ではまたゼロから書き始めます。

```c++
#define GLFW_INCLUDE_VULKAN
#include <GLFW/glfw3.h>

#define GLM_FORCE_RADIANS
#define GLM_FORCE_DEPTH_ZERO_TO_ONE
#include <glm/vec4.hpp>
#include <glm/mat4x4.hpp>

#include <iostream>

int main() {
    glfwInit();

    glfwWindowHint(GLFW_CLIENT_API, GLFW_NO_API);
    GLFWwindow* window = glfwCreateWindow(800, 600, "Vulkan window", nullptr, nullptr);

    uint32_t extensionCount = 0;
    vkEnumerateInstanceExtensionProperties(nullptr, &extensionCount, nullptr);

    std::cout << extensionCount << " extensions supported\n";

    glm::mat4 matrix;
    glm::vec4 vec;
    auto test = matrix * vec;

    while(!glfwWindowShouldClose(window)) {
        glfwPollEvents();
    }

    glfwDestroyWindow(window);

    glfwTerminate();

    return 0;
}
```

次に、この基本的なVulkanのコードをコンパイルして実行するためのmakefileを書きます。新しく `Makefile` という名前の空のファイルを作成します。変数やルールがどのように動作するかなど、makefile の基本的な経験がすでにあることを前提としますが、そうでない場合でも[このチュートリアル](https://makefiletutorial.com/)を読めばすぐに理解できるでしょう。

まず、makefileを簡単にかけるように、いくつかの変数を定義します。基本的なコンパイラフラグを指定する変数 `CFLAGS` を定義します。

```make
CFLAGS = -std=c++17 -O2
```

今回はモダンなC++ (`-std=c++17`)を使用し、最適化レベルを O2 に設定することにします。プログラムをより速くコンパイルするために -O2 を削除することもできますが、リリースビルドの際には -O2 を元に戻すことを忘れないでください。

同様に、リンカフラグを変数`LDFLAGS`を定義します。

```make
LDFLAGS = -lglfw -lvulkan -ldl -lpthread -lX11 -lXxf86vm -lXrandr -lXi
```

`-lglfw`フラグはGLFWのためのものであり、`-lvulkan`フラグは Vulkanファンクションローダとのリンクであり、残りのフラグは GLFW が必要とする低レベルのシステムライブラリです。残りのフラグは、スレッドやウィンドウマネジメントなどGLFW自体が依存するものです。

変数を定義したことで、`VulkanTest`をコンパイルするルールの指定は簡単になりました。インデントには、スペースのではなくタブを使うようにしてください。

```make
VulkanTest: main.cpp
    g++ $(CFLAGS) -o VulkanTest main.cpp $(LDFLAGS)
```

makefileを保存し、`main.cpp` と `Makefile` のあるディレクトリで `make` を実行して、このルールが動作することを確認してください。これで `VulkanTest` の実行ファイルが生成されるはずです。

ここで、`test` と `clean` という2つのルールを定義します。前者は実行ファイルを実行するもので、後者は生成された実行ファイルを消去するものです。

```make
.PHONY: test clean

test: VulkanTest
    ./VulkanTest

clean:
    rm -f VulkanTest
```

`make test`を実行しプログラムが正常に動作すると、Vulkanの拡張子の数が表示されるはずです。空のウィンドウを閉じると、アプリケーションは成功のリターンコード (`0`) で終了します。これで、以下のような完全な makefile ができました。

```make
CFLAGS = -std=c++17 -O2
LDFLAGS = -lglfw -lvulkan -ldl -lpthread -lX11 -lXxf86vm -lXrandr -lXi

VulkanTest: main.cpp
    g++ $(CFLAGS) -o VulkanTest main.cpp $(LDFLAGS)

.PHONY: test clean

test: VulkanTest
	./VulkanTest

clean:
    rm -f VulkanTest
```

このディレクトリを、Vulkan プロジェクトのテンプレートとして使うことができます。コピーして `HelloTriangle` のような名前に変更し、`main.cpp` のコードをすべて削除してください。

これで、[本格的な冒険](!ja/三角形を描く/セットアップ/ベースコード)の準備が整いました。

## MacOS

ここでは、Xcode と [Homebrew パッケージマネージャ](https://brew.sh/)を使用していることを前提としています。また、少なくとも MacOS のバージョン 10.11 以上が必要であり、お使いのデバイスが [Metal API](https://en.wikipedia.org/wiki/Metal_(API)#Supported_GPUs)をサポートしている必要があることも忘れないでください。

### Vulkan SDK

Vulkanアプリケーションの開発に必要な最も重要なコンポーネントはSDKです。SDKには、ヘッダ、標準のバリデーションレイヤー、デバッグツール、Vulkan関数のためのローダが含まれています。ローダは、実行時にドライバ内の関数を検索します。もし、あなたがよく知っているのならば、それはOpenGL用のGLEWと同様です。

SDKは、[LunarGウェブサイト](https://vulkan.lunarg.com/)のページ下部のボタンをからダウンロードすることができます。アカウントを作成する必要はありませんが、作成することで、有用なドキュメントにアクセスすることができます。

![](/images/vulkan_sdk_download_buttons.png)

MacOS版SDKは内部的に[MoltenVK](https://moltengl.com/)を使用しています。MacOSにはVulkanのネイティブサポートはありませんので、MoltenVKは実際にはVulkanのAPIコールをAppleのMetalグラフィックスフレームワークに変換するレイヤーとして機能します。これにより、AppleのMetalフレームワークのデバッグ機能や高いパフォーマンスを利用することが出来ます。

ダウンロードしたら、好きなディレクトリにコンテンツを展開してください（Xcode上でプロジェクトを作成する際に、そのディレクトリを参照する必要があることを覚えておいてください）。解凍したフォルダ内の `Applications` フォルダには、SDKを使用したデモを実行するファイルがあります。`vkcube`を実行すると、以下のようになります。

![](/images/cube_demo_mac.png)

### GLFW

前述の通り、Vulkan自体がプラットフォームに依存しないAPIであるため、レンダリング結果を表示するためのウィンドウを作成するためのツールは含まれていません。Vulkanのクロスプラットフォームの利点を享受し、Win32の恐怖を避けるために、Windows、Linux、MacOSに対応した[GLFWライブラリ](http://www.glfw.org/)を使ってウィンドウを作成します。[SDL](https://www.libsdl.org/)のような他のライブラリもありますが、GLFWの利点は、ウィンドウの作成以外にもVulkanにまつわるプラットフォーム固有のことを抽象化していることです。

MacOSにGLFWをインストールするには、Homebrewパッケージマネージャを使って `glfw` パッケージを取得します。

```bash
brew install glfw
```

### GLM

DirectX 12と違ってVulkanには線形代数演算用のライブラリが含まれていないので、ダウンロードする必要があります。[GLM](http://glm.g-truc.net/)は、グラフィックスAPIでの使用を想定して設計されており、OpenGLでもよく使われている素敵なライブラリです。

これはヘッダのみのライブラリです。`glm` パッケージからインストールすることができます。

```bash
brew install glm
```

### Xcodeのセットアップ

これで、すべての依存関係がインストールされたので、Vulkan用の基本的なXcodeプロジェクトをセットアップすることができます。ここでの説明のほとんどは、基本的にはプロジェクトとそれがリンクしているすべての依存ライブラリとをつなげるための「配管作業」です。また、以下の説明の中で `vulkansdk` というフォルダについて言及している場合は、Vulkan SDKを解凍したフォルダを参照していることに注意してください。

Xcodeを起動し、新しいXcodeプロジェクトを作成します。開いたウィンドウで、 Application > Command Line Tool を選択します。

![](/images/xcode_new_project.png)

`次へ`を選択し、プロジェクトの名前を入力し、`Language`では`C++`を選択します。

![](/images/xcode_new_project_2.png)

`Next`を押すと、プロジェクトが作成されているはずです。生成された `main.cpp` ファイルのコードを以下のように変更してみましょう。

```c++
#define GLFW_INCLUDE_VULKAN
#include <GLFW/glfw3.h>

#define GLM_FORCE_RADIANS
#define GLM_FORCE_DEPTH_ZERO_TO_ONE
#include <glm/vec4.hpp>
#include <glm/mat4x4.hpp>

#include <iostream>

int main() {
    glfwInit();

    glfwWindowHint(GLFW_CLIENT_API, GLFW_NO_API);
    GLFWwindow* window = glfwCreateWindow(800, 600, "Vulkan window", nullptr, nullptr);

    uint32_t extensionCount = 0;
    vkEnumerateInstanceExtensionProperties(nullptr, &extensionCount, nullptr);

    std::cout << extensionCount << " extensions supported\n";

    glm::mat4 matrix;
    glm::vec4 vec;
    auto test = matrix * vec;

    while(!glfwWindowShouldClose(window)) {
        glfwPollEvents();
    }

    glfwDestroyWindow(window);

    glfwTerminate();

    return 0;
}
```

今すぐにコードを理解しようとしなくて問題ありません。すべてがうまくいくことを確認するために、いくつかのAPIを呼び出しているだけです。

Xcodeはすでにライブラリが見つからないなどのエラーを表示しているはずです。これらのエラーを消すために、プロジェクトの設定をします。*Project Navigator*パネルでプロジェクトを選択し、*Build Settings*タブを開きます。

* **Header Search Paths**欄を見つけ、`/usr/local/include`(これは、Homebrewがヘッダをインストールする場所であり、ここに glm と glfw3 ヘッダファイルがあるはずです)へのリンクと、Vulkan ヘッダ用の `vulkansdk/macOS/include` へのリンクを追加します。
* **Library Search Paths**欄を見つけ、`/usr/local/lib` (これもまた、Homebrewがライブラリをインストールする場所であり、ここに glm と glfw3 の lib ファイルがあるはずです)へのリンクと、`vulkansdk/macOS/lib`へのリンクを追加してください。

以下のようになっているはずです（もちろん、ファイルをどこに置いたかによってパスは異なります）。

![](/images/xcode_paths.png)

さて、*Build Phases* タブの **Link Binary With Libraries** で `glfw3` と `vulkan` フレームワークの両方を追加します。簡単にするために、動的ライブラリをプロジェクトに追加します (静的フレームワークを使いたい場合は、ライブラリのドキュメントを確認してください)。

* glfw の場合は `/usr/local/lib` フォルダを開き、そこに `libglfw.3.x.dylib` のようなファイル名があります("x" はライブラリのバージョン番号です。いつHombebresからパッケージをダウンロードしたかに応じてことなります。)同様に、そのファイルをXcodeのLinked Frameworks and Librariesタブにドラッグシてください。
* vulkanの場合は `vulkansdk/macOS/lib` に移動し、`libvulkan.1.dylib` と `libvulkan.1.x.xx.dylib` の両方のファイル(xはダウンロードしたSDKのバージョン番号)も同様に追加します。

これらのライブラリを追加したら、同じタブの **Copy Files** で `Destination` を "Frameworks" に変更し、サブパスをクリアして、"Copy only when installing" の選択を解除します。"+"記号をクリックして、これら3つのフレームワークをすべてここに追加します。

Xcodeの設定は以下のようになっているはずです。

![](/images/xcode_frameworks.png)

最後に環境変数を設定する必要があります。Xcodeツールバーの `Product` > `Scheme` > `Edit Scheme...` と進み、`Arguments` タブで以下の2つの環境変数を追加します

* VK_ICD_FILENAMES = `vulkansdk/macOS/share/vulkan/icd.d/MoltenVK_icd.json`
* VK_LAYER_PATH = `vulkansdk/macOS/share/vulkan/explicit_layer.d`

以下のようになっているはずです。

![](/images/xcode_variables.png)

ついに、すべての設定が完了しました。プロジェクトを実行すると、以下のように表示されるはずです。(ビルドの設定をあなたが選んだ設定に応じて、デバッグまたはリリースに設定することを忘れないでください)。

![](/images/xcode_output.png)

コマンドプロンプトに表示されるエクステンションの数は0以外のはずです。他のログはライブラリからのものですが、設定によっては異なるメッセージが表示されるかもしれません。

これで[本番](!ja/三角形を描く/セットアップ/ベースコード)に向けての準備は完了です。
